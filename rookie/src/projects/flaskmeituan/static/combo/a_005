;M.add("mt-date",function(e){var t=e.Lang.isDate,a=e.Lang.isArray;e.namespace("mt.date"),e.mt.date={getTimeReduction:function(e,a,r){return t(e)&&t(a)?(r&&(e=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=new Date(a.getFullYear(),a.getMonth(),a.getDate())),a.getTime()-e.getTime()):null},isInRegions:function(e,a,r,n){if(!t(e)||!t(a)||!t(r))return!1;var i=this.getTimeReduction(a,e),o=this.getTimeReduction(e,r);return n?i>0&&o>0:i>=0&&o>=0},equalTime:function(e,t,a){return a?e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate():e.getTime()===e.getTime()},formatDate:function(t,a){if(!e.Lang.isDate(t))return null;var r=t.getFullYear(),n=t.getMonth(),i=t.getDate(),o=n+1,s=i;return o<10&&(o="0"+o),i<10&&(s="0"+s),a?[r,o,s].join(a):r+"年"+o+"月"+s+"日"},formatDateByString:function(e,t){if(e){var a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var r in a)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1===RegExp.$1.length?a[r]:("00"+a[r]).substr((""+a[r]).length)));return t}},isPeriodsOverlap:function(t,a){if(e.Lang.isArray(t)){a=!1!==a;var r=this;e.Array.each(t,function(t){var a=t[0],n=t[1];e.Lang.isString(a)&&(a=r.buildDateByFormatedString(a)),e.Lang.isString(n)&&(n=r.buildDateByFormatedString(n)),t[0]=a,t[1]=n});var n=!1;return e.Array.each(t,function(e,i){for(var o=i+1;o<t.length;o++){var s=t[o];if(r.isTwoPeriodOverlap(e,s,a))return void(n=!0)}}),n}},isTwoPeriodOverlap:function(e,t,a){var r=this.getTimeReduction(e[1],t[0]),n=this.getTimeReduction(t[1],e[0]);return a?!(r>=0||n>=0):!(r>0||n>0)},compareByString:function(e,t){var a=this.buildDateByFormatedString(e),r=this.buildDateByFormatedString(t);return this.compareDate(a,r)},compareDate:function(e,t){var a=e.getTime(),r=t.getTime();return a===r?0:a<r?-1:1},buildDateByFormatedString:function(t){if(e.Lang.isString(t)){t=e.Lang.trim(t);var a=t.split(" ")[0],r=t.split(" ")[1],n=a.split("-"),i=parseInt(n[0],10),o=parseInt(n[1],10),s=parseInt(n[2],10),g=0,c=0,u=0;if(r){var l=r.split(":");g=parseInt(l[0]||0,10),c=parseInt(l[1]||0,10),u=parseInt(l[2]||0,10)}return new Date(i,o-1,s,g,c,u)}},getMaxDaysInMonth:function(e,t){t=parseInt(t,10);return new Date(e,t,0).getDate()},fillTimeSection:function(t,a,r){a&&e.Lang.isArray(t)&&r&&(a.set("value",t[0]),r.set("value",t[1]))},_replaceOptionString2Node:function(t){for(var a=0;a<t.length;a++){var r=t[a];"string"==typeof r&&(t[a]=e.Node.create(r))}},buildDateSelect:function(t,r){var n=e.one(t);if(n){r=r||{},"undefined"==typeof r.options?r.options=[]:a(r.options)&&this._replaceOptionString2Node(r.options);var i=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],o=r.options;"year"===r.type?r.to=r.to||(new Date).getFullYear():(r.from=r.from||1,r.to=r.to<=12?r.to:12);for(var s=r.from;s<=r.to;s++){var g="",c=s,u="";"year"===r.type?g=s:(g=i[s-1],r.fillZero&&s<10&&(c="0"+s)),r.selectVal&&r.selectVal.toString()===c.toString()&&(u=" selected='selected'"),o.push(e.Node.create('<option value="'+c+'"'+u+">"+g+"</option>"))}n.setHTML(new e.NodeList(o).toFrag())}},calculateDay:function(e,t){var a,r,n;t=t||new Date;var i=[],o=this,s=/^([pnt]{1})(\d*)(\w+)/,g=e.match(s);if(/recentdays/.test(e)&&(n=e.split("-")[1],g=[e,"p",n,"day"]),g){var c=parseInt(g[2],10)||1,u=g[1];switch(g[3].substring(0,3)){case"day":i=o._calcDay(u,c,t);break;case"wee":i=o._calcWeek(u,c,t);break;case"mon":i=o._calcMonth(u,c,t);break;case"qua":i=o._calcQuarter(u,c,t);break;case"yea":i=o._calcYear(u,c,t);break;default:"today"===g[0]&&(a=r=t.getTime())}}if(i.length>0&&(a=i[0],r=i[1]),a>r){var l=a;a=r,r=l}return r=this.formatDate(new Date(r),"-"),a=this.formatDate(new Date(a),"-"),[a,r]},_calcDay:function(e,t,a){var r,n,i=1;switch(e){case"t":i=0;break;case"p":i=-1}return a.setDate(a.getDate()+t*i),r=a.getTime(),a.setDate(a.getDate()-t*i),n=a.getTime(),[r,n]},_calcWeek:function(e,t,a){var r,n,i=1,o=1,s=1,g=0===a.getDay()?7:a.getDay();switch(e){case"t":i=0;break;case"p":i=-1;break;case"n":s=7,o=-1}return a.setDate(a.getDate()+7*t*i-g+s),r=a.getTime(),a.setDate(a.getDate()-7*(t-1)*i+6*o),n=a.getTime(),[r,n]},_calcMonth:function(e,t,a){var r,n,i=1,o=1,s=0;switch(e){case"t":i=0,s=1;break;case"p":i=-1;break;case"n":t+=1,o=0,s=2}return a.setMonth(a.getMonth()+t*i),a.setDate(o),r=a.getTime(),a.setMonth(a.getMonth()-t*i+s),a.setDate(Number(!o)),n=a.getTime(),[r,n]},_calcQuarter:function(e,t,a){var r,n,i,o=parseInt(a.getMonth()/3,10)+1,s=3*o-2,g=1;switch(e){case"t":-1,r=3;break;case"p":-1,s-=3*t,r=3*t;break;case"n":s+=3*(t+1),g=0,r=-3*t+1}return a.setMonth(s-1),a.setDate(g),n=a.getTime(),a.setMonth(a.getMonth()+r),a.setDate(Number(!g)),i=a.getTime(),[n,i]},_calcYear:function(e,t,a){var r,n,i=1,o=0,s=1,g=11,c=31;switch(e){case"t":i=0;break;case"p":i=-1;break;case"n":o=g,s=c,g=0,c=1}return a.setFullYear(a.getFullYear()+i*t),a.setMonth(o),a.setDate(s),r=a.getTime(),a.setFullYear(a.getFullYear()-i*t+i),a.setMonth(g),a.setDate(c),n=a.getTime(),[r,n]}}},"1.0.0",{requires:["mt-base","node"]});
;M.add("w-calendar",function(e){function t(){t.superclass.constructor.apply(this,arguments)}var a=e.mt.date,n=e.mt.util,r=e.Lang,l={dayToday:"day--today",dayHover:"day--hover",daySelected:"day--selected",daySelectable:"day--selectable",dayCurMonth:"day--cur-month",dayPrevMonth:"day--prev-month",dayNextMonth:"day--next-month",ctlPrevMonth:"calendar-control--previous",ctlNextMonth:"calendar-control--next",ctlDisabled:"calendar-control--disabled",ctlDisplay:"calendar-control--display"},s={control:'<div class="calendar-controls"><a class="calendar-control {prevMonthClass}" href="javascript:void(0);" title="{prevMonthTitle}">&lsaquo;</a><span class="calendar-control calendar-control--display">{currentMonth}</span><a class="calendar-control {nextMonthClass}" href="javascript:void(0);" title="{nextMonthTitle}">&rsaquo;</a>{extraControlMarkup}</div>',table:'<table class="calendar-table" cellspacing="0" cellpadding="0" border="0"><thead class="calendar-table__header">{header}</thead><tbody class="calendar-table__body">{body}</tbody></table>',cell:'<td class="day {dayClass}" data-day="{day}"><div class="day__wrapper"><span class="day__num">{day}</span></div></td>',cellEmpty:'<td class="day {dayClass}" data-day="{day}"><div class="day__wrapper">&nbsp;</div></td>',cellHeader:'<td class="weekday">{label}</td>'};t.NAME="Calendar",t.CSS_PREFIX="widget-calendar",t.ATTRS={container:{value:null,setter:function(t){return e.one(t)},writeOnce:!0},showPrevMonthDays:{value:!1,writeOnce:!0},showNextMonthDays:{value:!1,writeOnce:!0},extraControlMarkup:{value:"",writeOnce:!0},startOnSunday:{value:!0,writeOnce:!0},minDate:{value:null,setter:"_setMindate"},maxDate:{value:null,setter:"_setMaxdate"}},e.extend(t,e.Widget,{initializer:function(){var e=this;if(!e.get("container"))throw new Error(t.NAME+": 没有设置container或container不存在");e.currentDate=new Date,e.canPrevMonth=!0,e.canNextMonth=!0,e.publish("refresh",{emitFacade:!0,defaultFn:e.refresh}),e.publish("select",{emitFacade:!0,defaultFn:e._defSelectFn}),e.render()},renderUI:function(){this.get("container").setHTML(this._generateHTML())},bindUI:function(){var e=this,t=this.get("container"),a="."+l.daySelectable,r="."+l.ctlPrevMonth,s="."+l.ctlNextMonth;t.delegate("click",function(t){var l=this,o=e.currentDate,d=o.getFullYear(),c=o.getMonth(),i=n.data(l,"day"),u=new Date(d,c,i);l.test(a)?e.fire("select",{ndTarget:l,currentDate:o,selectedDate:u}):l.test(r)?(t.preventDefault(),e.prevMonth()):l.test(s)&&(t.preventDefault(),e.nextMonth())},[r,s,a].join(","))},getSelectable:function(){return this.get("container").all("."+l.daySelectable)},getSelected:function(){return this.get("container").all("."+l.daySelected)},prevMonth:function(){var e=this;e.canPrevMonth&&(e.currentDate.setDate(1),e.currentDate.setMonth(e.currentDate.getMonth()-1),e.canNextMonth=!0,e.fire("refresh",{currentDate:e.currentDate}))},nextMonth:function(){var e=this;e.canNextMonth&&(e.currentDate.setDate(1),e.currentDate.setMonth(e.currentDate.getMonth()+1),e.canPrevMonth=!0,e.fire("refresh",{currentDate:e.currentDate}))},refresh:function(){var e=this;e.get("container").setHTML(e._generateHTML())},setDate:function(e){var t,a=this,n=a.currentDate,l=!0;r.isDate(e)?t=e:(t=new Date,t.setTime(Date.parse(e))),n.getFullYear()===t.getFullYear()&&n.getMonth()===t.getMonth()&&(l=!1),a.currentDate=t,l&&(a.refresh(),a.fire("refresh",{currentDate:a.currentDate}))},_defSelectFn:function(e){var t=e.ndTarget,a=l.daySelected;t.hasClass(a)?t.removeClass(a):t.addClass(a)},_setMindate:function(e){if(r.isDate(e))return e;if(r.isString(e)){var t=new Date(e);return new Date(t.getFullYear(),t.getMonth(),t.getDate())}return new Date(2010,3,4)},_setMaxdate:function(e){if(r.isDate(e))return e;if(r.isString(e)){var t=new Date(e);return new Date(t.getFullYear(),t.getMonth(),t.getDate())}return new Date(2099,12,31)},_generateHTML:function(){return this._generateCalendarControl()+this._generateCalendarTable()},_generateCalendarControl:function(){var t,a=this,n=s.control,r=a.get("minDate"),o=a.get("maxDate"),d=a.currentDate,c=d.getFullYear(),i=d.getMonth(),u=l.ctlPrevMonth,h=l.ctlNextMonth;return i<=r.getMonth()&&c<=r.getFullYear()&&(u+=" "+l.ctlDisabled,a.canPrevMonth=!1),i>=o.getMonth()&&c>=o.getFullYear()&&(h+=" "+l.ctlDisabled,a.canNextMonth=!1),t={prevMonthTitle:0===i?c-1+"年12月":c+"年"+i+"月",prevMonthClass:u,nextMonthTitle:11===i?c+1+"年1月":c+"年"+(i+2)+"月",nextMonthClass:h,extraControlMarkup:a.get("extraControlMarkup"),currentMonth:c+"年"+(i+1)+"月"},e.mix(t,l),e.Lang.sub(n,t)},_generateCalendarTable:function(){var t,a=s.table;return t={body:this._generateCalendarCells(),header:this._generateCalendarHeader()},e.Lang.sub(a,t)},_generateCalendarHeader:function(){var e=this,t=e.get("startOnSunday"),a=s.cellHeader,n=["一","二","三","四","五","六","日"],l=["<tr>"];t&&n.unshift(n.pop());for(var o=0;o<7;o++)l.push(r.sub(a,{label:n[o]}));return l.push("</tr>"),l.join("")},_generateCalendarCells:function(){var e,t,n,o,d=this,c=d.get("startOnSunday"),i=s.cell,u=s.cellEmpty,h=l.dayToday,M=l.daySelectable,g=l.dayCurMonth,y=l.dayPrevMonth,D=l.dayNextMonth,v=d.get("showPrevMonthDays"),f=d.get("showNextMonthDays"),p=d.get("minDate"),b=d.get("maxDate"),C=d.currentDate,x=C.getFullYear(),w=C.getMonth(),_=new Date(x,w,1),m=_.getDay(),S=new Date,T=_,F=0===w?11:w-1,N=a.getMaxDaysInMonth(x,F+1),P=a.getMaxDaysInMonth(x,w+1),H=P,Y=[];for(e=c?m:m?m-1:6,t=(7-(e+P)%7)%7,Y.push("<tr>"),n=1;n<=e;n++)Y.push(r.sub(v?i:u,{dayClass:y,day:N-e+n}));for(n=1;n<=H;n++)T.setDate(n),o=[g],a.isInRegions(T,p,b)&&o.push(M),0===a.getTimeReduction(T,S,!0)&&o.push(h),Y.push(r.sub(i,{dayClass:o.join(" "),day:n})),(n+e)%7==0&&n<H&&Y.push("</tr><tr>");for(n=1;n<=t;n++)Y.push(r.sub(f?i:u,{dayClass:D,day:n}));return Y.push("</tr>"),Y.join("")}}),e.mt.widget.Calendar=t},"1.0.0",{requires:["mt-base","widget","mt-date","node"]});
;M.add("deal-digest-travelcalendar",function(e){var a=e.mt.util,t=e.mt.www;t.DealDigestTravelCalendar=function(){return{init:function(){function t(e){var a=e.currentDate;n(a.getFullYear(),y.getRealMonth(a.getMonth()))}function n(e,a){u.all(".day--selectable").each(function(t){var n=y.formatNumber(t.getData("day")),s=""+e+a+n,i=h[s];if(i){var c=h[s].stock;!i.isFilter&&c>0?c>=10?r(t,i,!0):r(t,i):l(t)}else l(t)})}function r(e,a,t){var n=t?"":"<p>剩"+a.stock+"</p>";n+='<p class="day__title">'+e.getData("day")+"</p>",n+='<p class="day__title"><span class="J-travel-buy-price">¥'+a.price+"</span></p>",e.addClass("day--enable").setHTML(n)}function l(e){e.removeClass("day--enable").removeClass("day--selectable").addClass("day--full").addClass("day--unavailable").setHTML('<p class="day__title">'+e.getData("day")+"</p><p>不可约</p>")}function s(a){var t=a.selectedDate.getFullYear(),n=a.selectedDate.getMonth()+1,r=y.formatNumber(n),l=a.selectedDate.getDate(),s=y.formatNumber(l),i=""+t+r+s,c=e.one(".J-cart-quantity"),o="";c&&(o=e.one(".J-cart-quantity").get("value"));var d="/deal/buy/"+N+"?q="+o+"&selectDate="+i,u=y.formatDate(i);g.set("value",u),f.setHTML(y.getWeekDay(u)),window.location.href=d}function i(e){return e=e.toString(),e.substring(0,4)+"-"+e.substring(4,6)+"-"+e.substring(6,8)}var c=e.one("#J-travel-form");if(c){var o=e.one("#J-travel-calendar");if(o){var d,u,g=e.one("#J-start-date"),f=e.one(".J-checkin-info"),D=this,v=c.getData("params"),m=a.decodeJSON(v),y=D.helper,h=m.priceCalendarArr,b=m.startDate,p=m.minValidDate?m.minValidDate:b,w=i(b),C=i(p),J=i(m.endDate),M=new Date(w),k=o.getData("params"),T=a.decodeJSON(k),N=T.dealid;g.set("value",C);var _=y.getWeekDay(C);f.setHTML(_),function(){(u=e.one("#J-travel-calendar"))&&(d=new e.mt.widget.Calendar({container:u,startOnSunday:!0,minDate:w,maxDate:J}),n(M.getFullYear(),y.getRealMonth(M.getMonth())))}(),function(){u&&d&&(c.delegate("click",function(){u.show()},".J-travel-checkin"),d.after("refresh",t),d.on("select",s),u.delegate("click",function(e){u.hide()},".day--selectable"),e.one("body").on("click",function(e){var a=e.target;a===g||a.hasClass("calendar")||a.hasClass("calendar-control")||a.hasClass("arrow")||u.contains(a)||a.hasClass("time-info")||u.hide()}))}()}}},helper:{formatDate:function(e){return e.substring(0,4)+"-"+e.substring(4,6)+"-"+e.substring(6,8)},getRealMonth:function(e){return("0"+(e+1)).slice(-2)},formatNumber:function(e){return e<10?"0"+e:e},getWeekDay:function(e){var a=new Date(e),t=new Date,n=["周日","周一","周二","周三","周四","周五","周六"],r=(t.getTime()-a.getTime())/864e5;return r>=0&&r<1?"今天":n[a.getDay()]}}}}(),e.mt.ComponentHub.attach("deal-digest-travelcalendar",function(){t.DealDigestTravelCalendar.init()})},"1.0.0",{requires:["www-base","www-dialog","w-calendar"]});
;M.add("www-pagenav",function(a){function e(e,t,n){n=n||{},this._ndPageNav=a.one(e),this.bindEvent(),this.gaBase=n.gaBase,this.callBack=t}var t='<li class="{class}"><a href="javascript:void(0);"{gaevent} hidefocus="true" data-index="{index}">{linkText}{tri}</a></li>';e.prototype={render:function(e){var t=[],n={hasHeadEnd:!0,currentPage:1,minPage:1,maxPage:99,extraNum:2,showNavCount:0,gaBase:""},s=this._ndPageNav;if(this.config=a.merge(n,e),n=this.config,n.currentPage<n.minPage||n.currentPage>n.maxPage||n.minPage===n.maxPage)return s.setHTML(""),void s.hide();this.getPrePage(t),this.getInnerPage(t),this.getNextPage(t),s.show(),s.setHTML(t.join(""))},getInnerPage:function(e){function n(n){l.minPage<=n&&l.maxPage>=n&&(n===l.currentPage?e.push('<li class="current"><span data-index="'+n+'">'+n+"</span></li>"):e.push(a.Lang.sub(t,{gaevent:r.getGA(n),index:n,tri:"","class":"page-link",linkText:n})))}var s,i,g,r=this,c=this._offset||0,u=c+1,l=r.config,o=0;if(l.showNavCount>0)for(i=parseInt(l.showNavCount/2,10),l.showNavCount>=l.maxPage?u=1:l.showNavCount-l.currentPage+c>=i&&l.currentPage!==c+1?u=c+1:(s=l.maxPage-l.currentPage<i?l.maxPage-l.currentPage:i,g=l.showNavCount-(l.currentPage-c)-s,u-=g,c-=g,u=u>0?u:1,c=c>0?c:0,r._offset=c);o<l.showNavCount;)n(u),o++,u++;else for(o=2*l.extraNum+1,u=l.currentPage-l.extraNum;o>0;)n(u),o--,u++},getPrePage:function(e){var n=this.config;n.currentPage===n.minPage?(n.hasHeadEnd&&e.push('<li class="first-page"><span>首页</span></li>'),e.push('<li class="previous"><span><i class="tri disable"></i>上一页</span></li>')):(n.hasHeadEnd&&e.push(a.Lang.sub(t,{gaevent:this.getGA("firstpage"),index:1,tri:"","class":"first-page",linkText:"首页"})),e.push(a.Lang.sub(t,{gaevent:this.getGA("prepage"),index:n.currentPage-1,"class":"previous",tri:'<i class="tri"></i>',linkText:"上一页"})))},getNextPage:function(e){var n=this.config;n.currentPage===n.maxPage?(e.push('<li class="next"><span>下一页<i class="tri disable"></i></span></li>'),n.hasHeadEnd&&e.push('<li class="last-page"><span>尾页</span></li>')):(e.push(a.Lang.sub(t,{gaevent:this.getGA("nextpage"),index:n.currentPage+1,"class":"next",tri:'<i class="tri"></i>',linkText:"下一页"})),n.hasHeadEnd&&e.push(a.Lang.sub(t,{gaevent:this.getGA("lastpage"),index:n.maxPage,tri:"","class":"last-page",linkText:"尾页"})))},getGA:function(a){var e=this.config.gaBase;return e?' gaevent="'+e+a+'"':""},bindEvent:function(){var a=this;this._ndPageNav.delegate("click",function(e){var t=parseInt(e.currentTarget.getAttribute("data-index"),10);a.callBack?a.callBack({index:t}):a.render({currentPage:t,maxPage:a.maxPage})},"a[data-index]")}},e.prototype.constructor=e,a.mt.www.PageNav=e},"1.0.0",{requires:["www-base"]});
;M.add("review-list",function(t){function e(t){return"."+t}var i=t.io,a=t.mt.util,n=function(){this._attrs={tab:"all",withContent:!0,sortType:"default",label:null}};n.prototype={constructor:n,set:function(t,e){this.get(t)!==e&&(this._set(t,e),this._updateRestAttrs(t,e),this.fire("attrchange"))},get:function(t){return this._attrs[t]},_set:function(t,e){this._attrs[t]=e},_updateRestAttrs:function(t,e){switch(t){case"label":return void this._afterLabelChange(e);case"withContent":return void this._afterWithContentChange(e);case"tab":this._afterTabChange(e)}},_afterLabelChange:function(t){t&&(this._set("tab",null),this._set("withContent",!0))},_afterWithContentChange:function(t){var e=this.get("tab");t||("withpic"!==e&&null!==e||this._set("tab","all"),this._set("label",null))},_afterTabChange:function(t){null!==t&&("withpic"===t&&this._set("withContent",!0),this._set("label",null))}},t.augment(n,t.EventTarget);var l=function(e){var i={rateFilter:null,placeholder:null,action:""};this.config=t.merge(i,e),this.ndLabelsWrapper=null};l.CLASS_LABELS_WRAPPER="J-labels-wrapper",l.prototype={constructor:l,init:function(){var t=this;i(this.config.action,{method:"GET",on:{success:function(e,i){var n,l,r,s,o=a.getEvalRes(i);(n=o.data)&&(l=n.length)&&(r=o.trackData,r&&(s=r.pm),window._mbq("trackModuleview",r),t._render(n,l,s),t._bindEvents())}}})},_render:function(e,i,a){var n,r,s,o,c,d=a?'data-mod="'+a+'"':"",h='<div class="rate-labels-wrapper '+l.CLASS_LABELS_WRAPPER+'" '+d+'><p class="title">大家都在说：</p><div class="labels">',g=1,u=1,f=this.config.placeholder;for(n=0;n<i;n++)s="rate-label",r=e[n],r.isPositive?(s+=" rate-label--positive",c="content/detail/reviews/cloud/good"+g,g++):(c="content/detail/reviews/cloud/bad"+u,u++),h+='<a href="#" class="'+s+'" data-label="'+r.label+'" hidefocus="true" gaevent="'+c+'">'+r.label+"("+r.count+")</a>";h+="</div></div>",o=this.ndLabelsWrapper=t.Node.create(h),f&&f.insert(o,"after")},_bindEvents:function(){var e=this.ndLabelsWrapper,i=this.config.rateFilter;i.on("attrchange",t.bind(this._updateView,this)),e.delegate("click",function(t){t.preventDefault();var e=t.target,a=e.getData("label");a!==i.get("label")&&i.set("label",a)},"a")},_updateView:function(){var t=this.ndLabelsWrapper,e=this.config.rateFilter,i=e.get("label");if(t){var a,n="rate-label--positive--active",l=t.one(".rate-label--active, ."+n);l&&(l.removeClass("rate-label--active"),l.removeClass(n)),i&&(a=t.one('[data-label="'+i+'"]'),a.hasClass("rate-label--positive")?a.addClass(n):a.addClass("rate-label--active"))}}};var r=function(i){var a,s={pageLimit:10,hasLabelCloud:!1,labelCloudAction:null,labelPlaceholder:"#J-overview",isDeal:!0,dealId:0,poiId:"all",cityId:0,showPoiTitle:"0",ndWrapper:t.one(e(r.CLASS_RATE_LIST_WRAPPER)),ndFilter:t.one(e(r.CLASS_FILTER_WRAPPER)),ndWithContent:t.one(e(r.CLASS_WITH_CONTENT_CHECKBOX)),ndSortSelect:t.one(e(r.CLASS_SORT_TYPE_SELECT)),ndPageNav:t.one(e(r.CLASS_PAGE_NAV))};if(this.config=i=t.merge(s,i),i.isDeal&&"all"===i.dealId||!i.isDeal&&"all"===i.poiId)return null;i.rateFilter=new n,a=t.one(this.config.labelPlaceholder),i.hasLabelCloud&&void 0!==a&&(i.labelCloud=new l({rateFilter:i.rateFilter,placeholder:a,action:i.labelCloudAction})),this.init()};r.CLASS_RATE_LIST_WRAPPER="J-rate-wrapper",r.CLASS_RATE_LIST="J-rate-list",r.CLASS_RATE_LIST_LOADING="J-list-loading",r.CLASS_FILTER_WRAPPER="J-rate-filter",r.CLASS_WITH_CONTENT_CHECKBOX="J-rate-withcontent",r.CLASS_PAGE_NAV="J-rate-paginator",r.CLASS_SORT_TYPE_SELECT="J-filter-ordertype",r.CLASS_TAB_LINK="J-filter-link",r.TPL_LOADING='<div class="loading-surround--large ratelist-content__loading J-list-loading"></div>',r._cachedRatelist={},r.prototype={constructor:r,init:function(){var i,a=this.config,n=a.labelCloud,l=this.config.ndWrapper;this._ndLoading=t.Node.create(r.TPL_LOADING),this._ndRatelist=l.one(e(r.CLASS_RATE_LIST)),l.insert(this._ndLoading,this._ndRatelist),this._ndLoading.hide(),n&&n.init(),this._bindFilterEvents(),r.bindEvents(this.config.ndWrapper),this._ndRatelist.getData("fetchfirstpage")?this._refreshRatelist():(i=parseInt(this.config.ndPageNav.getData("total"),10),this._renderPageNav(i,0),r.renderRatePicList(this.config.ndWrapper))},_refreshRatelist:function(e){var i,n,l=this.config,r=this,s=l.rateFilter,o=s.get("tab"),c=s.get("label"),d={dealId:l.dealId,cityId:l.cityId,id:l.dealId,poiId:l.poiId,filter:"all",withContent:0,sortType:s.get("sortType"),label:"",isPoi:""},h={limit:l.pageLimit,showpoititle:l.showPoiTitle,offset:e||0};"withpic"===o?h.withpic=1:o&&(d.filter=o),c?(n="/deal/{isPoi}feedbacklistbylabel/{id}/{label}/{sortType}",d.label=encodeURI(c),"all"!==l.poiId&&(d.isPoi="poi",d.id=l.poiId)):n="/deal/feedbacklist/{dealId}/{poiId}/{filter}/{withContent}/{sortType}/{cityId}",i=t.Lang.sub(n,d),i=i+"?"+a.toPostData(h),this._fetchReviewListData(i,function(e){var i=e.data;e.status&&(r._renderRateList(i.ratelistHtml),r._renderPageNav(i.total,h.offset),t.Global.fire("PageHeight:change"))})},_fetchReviewListData:function(t,e){var n,l,s=r._cachedRatelist[t];if(s)return void e(s);this.config.ndWrapper,n=this._ndLoading,l=this._ndRatelist,n.show(),l.hide(),i(t,{method:"GET",on:{success:function(i,s){n.hide(),l.show();var o=a.getEvalRes(s);r._cachedRatelist[t]=o,e(o)}}})},_renderPageNav:function(e,i){new t.mt.www.PageNav(this.config.ndPageNav).render({currentPage:Math.ceil((parseInt(i,10)+1)/this.config.pageLimit),maxPage:Math.ceil(e/this.config.pageLimit),gaBase:"content/detail/reviews/prepage"})},_renderRateList:function(t){var e=this._ndRatelist;e.setHTML(t),r.renderRatePicList(e)},_bindFilterEvents:function(){var t=this.config.ndWrapper,i=this,n=this.config.rateFilter,s=this.config.ndFilter,o=this.config.ndSortSelect,c=this.config.ndWithContent;n.on("attrchange",function(){i._updateFilterView(),i._refreshRatelist()}),c.on("change",function(t){var e,i=t.target;e=i.get("checked"),n.set("withContent",e)}),s.delegate("click",function(t){t.preventDefault();var e=this.getData("tab");e!==n.get("tab")&&n.set("tab",e)},e(r.CLASS_TAB_LINK)),o.on("change",function(){var t=o.get("value");n.set("sortType",t)}),this.config.ndPageNav.delegate("click",function(){var n,r=this,o=1,c=t.one(e(l.CLASS_LABELS_WRAPPER)),d="";o=a.data(r,"index"),c?window.scrollTo(0,c.getY()-46):window.scrollTo(0,s.getY()-46),d=this.getAttribute("data-index"),d&&d.length<2&&(d="0"+d),window._gaq.push(["_trackEvent","InnerLink","Click","content/detail/review/page"+d]),n=(o-1)*i.config.pageLimit,i._refreshRatelist(n)},"a")},_updateFilterView:function(){this._updateFilterWithContent(),this._updateFilterTabs()},_updateFilterWithContent:function(){var t=this.config.ndWithContent,e=this.config.rateFilter,i=e.get("withContent");t.set("checked",i)},_updateFilterTabs:function(){var t=this.config,e=t.rateFilter,i=t.ndFilter,a=e.get("tab"),n=i.one(".rate-filter__link--active"),l=i.one('[data-tab="'+a+'"]');n&&n.removeClass("rate-filter__link--active"),l&&l.addClass("rate-filter__link--active")}};var s={bindEvents:function(t){t.delegate("click",function(){s.agreeEvaluate(this,this.getData("feedbackId"))},".J-useful"),t.delegate("click",function(t){t.halt();var e=this.ancestor(".J-ratelist-item"),i=e.getData("rateid"),a=e.one(".J-normal-view"),n=e.one(".J-long-view");if(n.getData("rendered"))return a.toggleView(),n.toggleView(),void window.scrollTo(0,e.getY()-46);s.getRateLongDetail(i,function(t){n.setHTML(t.comment),n.setData("rendered",!0),a.toggleView(),n.toggleView(),n.append('<p><a href="#" class="J-show-moreorless">收起</a></p>')})},".J-show-moreorless")},agreeEvaluate:function(e,n){var l,r,s=e.siblings(".J-agree-tips"),o={dealfeedbackid:n};l=t.Lang.sub("/deal/vote/{dealfeedbackid}",o),r=parseInt(e.getData("agreed"),10),i(l,{method:"POST",on:{success:function(t,i){var n=a.getEvalRes(i);0===n.status&&(r+=1,e.set("title","有"+r+"人认为这条评价有用"),e.set("data-feedbackId",r),e.setHTML('有用<span class="number">('+r+")</span>")),s.set("text",n.msg)}}})},getRateLongDetail:function(t,e){i("/rates/longdetail/"+t,{method:"GET",on:{success:function(t,i){var n=a.getEvalRes(i);e(n)}}})},buildSingleRatePicItem:function(t){var e,i,a,n;if(!t)return"";if(!(n=t.length))return"";for(a='<div class="pic-list J-piclist-wrapper"><div class="J-pic-thumbnails pic-thumbnails"><ul class="pic-thumbnail-list">',e=0;e<n;e++)i=t[e],a+='<li data-src="'+i.url+'"><a class="pic-thumbnail" href="#" hidefocus="true">    <img src="'+i.url.replace("/w.h/","/126.126/")+'"/></a></li>';return a+='</ul></div><div class="J-pic-preview pic-preview"></div></div>'},renderRatePicList:function(e){if(e){var i=e.all(".J-piclist-wrapper");i.isEmpty()||t.use("w-carousel",function(t){i.each(function(e){new t.mt.widget.Carousel({contentBox:e,ndCarousel:".J-pic-preview",ndIndicatorWrap:".J-pic-thumbnails",fillLastPage:!0,getCarouselSrc:function(t){return t.getData("src").replace("/w.h/","/668.500/")}}).render()})})}}};t.mix(r,s),t.namespace("mt.www.ReviewList"),t.mt.www.ReviewList=r,t.mt.ComponentHub.attach("review-list",function(i){var a=i.component.params;t.mt.ViewportTracker.onceenter(t.one(e(a.ndWrapper||r.CLASS_RATE_LIST_WRAPPER)),function(){new r(a)})})},"1.0.0",{requires:["www-base","www-pagenav","mt-viewporttracker"]});
;M.add("soso-map",function(e){var o=e.io,n=e.Lang.isArray,t=e.Lang.trim,a=e.mt.util,i=e.mt.www,r=e.mt.Dialog,s=e.mt.lang;e.mt.www.Map={showBizMap:function(o,n){window.qq&&window.qq.maps?i.Map.printBizMap(o,n):M.load(function(){e.Get.js("//map.qq.com/api/js?v=2.exp&callback=Y.mt.www.Map.callback",function(e){e||i.Map.printBizMap(o,n)})})},printBizMap:function(c,p){function l(){e.Array.each(L.get("markers"),function(e,o){e.setAnimation(q.MarkerAnimation.DROP),L.addListener(e,"click",function(){m(),j.openInfoWindow(o)})})}function u(){var o=c.shops;c.shops={},e.Object.each(o,function(e,o){e.name&&n(e.position)&&2===e.position.length&&(c.shops[o]=e)})}function d(){var o={container:y,markers:[],options:{scrollwheel:!0}};e.mix(o,c,!1,["center","zoom"]),e.Object.each(c.shops,function(e){o.markers.push({position:e.position,title:e.name})}),1!==o.markers.length||o.zoom||(o.zoom=16,o.center=o.markers[0].position),L=new e.mt.Map(o),l(),L.render(),L.get("map")&&B.on("click",function(){m()})}function h(){if(!c.shops)return void A.each(function(e){e.all(".view-map, .search-path, .correct-poi").hide()});A.each(function(e){e.delegate("click",function(e){e.preventDefault();var o=a.data(this,"id"),n=a.data(this,"poiid"),t=c.shops[o];t&&m(t,o,n)},".view-map"),e.delegate("click",function(e){e.halt();var o=a.data(this,"id"),n=c.shops[o];n&&f(n)},".search-path"),e.delegate("click",function(e){e.halt();var o=a.data(this,"id"),n=a.data(this,"poiid"),t=c.shops[o];t&&w(t,n)},".correct-poi")})}function m(o,n,t){var a,i,p,l="",u=[],d=b(o,n),h=o?o.name:c.name;o&&(l='<a href="javascript:void(0)" class="correct-poi">信息纠错</a>'),h=d.markers.length>1?s.truncateStr(h,16,"..."):h,z=new r({id:H,width:"770px",content:e.Lang.sub(D.getHTML(),{title:h,errorToCorrect:l})}),z.open(),a=e.one("#"+H),i=a.one(".map-container"),z.on("close",function(){i.hide()}),a.delegate("click",function(e){e.halt();var o=c.shops[n];o&&t&&(z.close(),w(o,t))},".correct-poi"),a.delegate("click",function(){window._gaq.push(["_trackEvent","InnerLink","Click","map/view/close"])},".close"),j&&j.destroy(),j=M(a,d),j.render(),j.get("map")&&(1===d.markers.length?j.openInfoWindow(0):(p=a.one(".select-shop"),e.Object.each(c.shops,function(e,o){u.push('<option value="'+o+'">'+e.name+"</option>")}),p.append(u.join("")),p.show(),p.on("change",function(){var o=this.get("value"),n=e.Array.indexOf(C,o);j.openInfoWindow(n)})))}function f(o){var n=null;O=new r({id:S,width:"420px",title:"查询线路",content:e.Lang.sub(E.getHTML(),{shopName:o.name,shopLatLng:o.position.concat().reverse().join()})}),O.open(),n=e.one("#"+S),v(n)}function w(o,n){var t=null;I&&(x=new r({id:W,width:"520px",title:"信息报错",content:e.Lang.sub(I.getHTML(),{shopName:o.name,shopAddress:o.address,shopPhone:o.phone,poiid:n})}),x.open(),t=e.one("#"+W),g(t))}function v(e){var o=e.one("form"),n=e.one(".error"),t=a.field(o,"from");o.on("submit",function(e){return e.halt(),""===t.get("value")?(n.setHTML("请填写您的出发地").setStyle("display","block"),t.focus(),!1):(n.hide(),o.submit(),!0)})}function g(n){function r(){return!(t(l.get("value"))&&!l.hasClass("placeholder")||u.get("checked")||h.get("checked"))}var s=n.one("form"),c=s.one('input[type="submit"]'),p=n.one("div.correct-group"),l=n.one("#correct-poi-info"),u=n.one("#number-error"),d=n.one(".field-group--error"),h=n.one("#connect-error");e.one("body").on("keydown",function(o){o.keyCode===e.mt.macro.key.ESC&&x.close()}),s.delegate("click",function(e){var o=e.target;"true"===a.data(o,"phoneerror")?(p.show(),p.one("input").focus()):p.hide()},'input[name="type"]'),l.plug(e.mt.plugin.Placeholder),s.on("submit",function(e){if(e.halt(),r())return void d.show();d.hide(),i.disableButton(c,!0),o(s.get("action"),{method:"POST",form:{id:s},on:{success:function(e,o){k(!!a.getEvalRes(o).status)},failure:function(){}}})})}function k(e){var o;o=e?{type:"success",title:"提交成功！",tip:"感谢您的报错信息."}:{type:"failure",title:"提交失败",tip:"网络有问题，请稍候重试"},x.showResult(o),x.set("autoHide",2)}function b(o,n){var t=c.shops,a={center:[],defaultZoom:16,markers:[],infoWindows:[]};return o&&(t={},t[n]=o),C=[],e.Object.each(t,function(o,n){var t=[],i=e.Lang.sub(T,{destination:o.position.concat().reverse().join()});t.push('<div class="info-window"><h5>'+o.name+"</h5>"),o.address&&t.push('<p class="detail">'+o.address+"</p>"),o.phone&&t.push('<p class="detail">'+o.phone+"</p>"),t.push('<p><a href="'+i+'" target="_blank" gaevent="map/view/queryroute">公交/驾车路线查询&raquo;</a></p></div>'),a.markers.push({position:o.position,title:o.name}),a.infoWindows.push(t.join("")),C.push(n)}),a}function M(o,n){var t={container:o.one(".map-container"),options:{mapTypeControl:!0,zoomControlOptions:{style:q.ZoomControlStyle.LARGE},panControl:!0,scaleControl:!0}};return e.mix(n,t),new e.mt.Map(n)}var y,q=window.qq&&window.qq.maps;if(c&&q&&(!p||(y=e.one("#map-canvas")))){var L,j,C,z,O,x,A=e.all(".address-list"),B=y&&y.next(".J-view-full"),T="//map.qq.com/?type=nav&tocoord={destination}&c={destination}&l=13",H="deal-view-map-dialog",S="deal-search-path-dialog",W="correct-poi-dialog",D=e.one("#view-map-markup"),E=e.one("#search-path-markup"),I=e.one("#correct-poi-markup");e.use("mt-map",function(){p&&(u(),d()),A&&h()}),e.Global.on("dealMapMarkers:change",function(o,n){var t=[];L.deleteMarkers(),e.Object.each(o.shops,function(e){t.push({position:e.position,title:e.name})}),L.set("markers",t),L.drawMarkers(),L.set("bounds",L.get("markers")),L.fitBounds(),l(),n&&n()})}},callback:function(){}},e.mt.ComponentHub.attach("soso-map",{ready:function(o){var n=o.component,t=n.params,a=t.callback;if(a&&"function"==typeof a)return void a();e.mt.www.Map.showBizMap(t.mapData,t.flag)}})},"1.0.0",{requires:["www-base","mt-dialog"]});
;M.add("rightbottom-sticky",function(t){var i=t.mt.www,o=t.mt.util,e=t.mt.Dialog,n=t.io;i.RightbottomSticky={init:function(e){var n,a;if((n=e.component.node)&&(a=n.one("#fixbar-container"))){var m=o.decodeJSON(a.getData("config"))||{};t.mix(m,{topConfig:{},voteConfig:{},helpConfig:{},feedbackConfig:{},containerConfig:{}}),function(i,o){i&&(o=o||{},t.mix(o,{mainAreaWidth:980,bottomEdge:".site-info-w",bottomOffset:20}),t.use("uix-sticky",function(t){new t.mt.uix.Sticky(i,{canDisappear:!0,mainAreaWidth:o.mainAreaWidth,bottomEdge:o.bottomEdge,hAlign:"right",vAlign:"bottom",vBottomOffset:o.bottomOffset})}))}(a,m.containerConfig),function(i){var o=n.one("#fixbar-item-top");o&&(i=i||{},t.mix(i,{maxAreaWidth:980,bottomEdge:".site-info-w",content:"",minScrollTop:140,bottomOffset:20}),t.use("uix-smoothscroll","uix-sticky",function(t){t.mt.uix.Smoothscroll(o,{trigger:".J-go-top"}),new t.mt.uix.Sticky(o,{canDisappear:!0,mainAreaWidth:i.mainAreaWidth,bottomEdge:i.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:i.minScrollTop,vBottomOffset:i.bottomOffset})}))}(m.topConfig),function(i){var o=n.one("#fixbar-item-vote");if(o){if(i=i||{},i.hide)return void o.hide();t.mix(i,{maxAreaWidth:980,bottomOffset:20,minScrollTop:0,bottomEdge:".site-info-w",ga:"",url:"/survey/82"}),t.use("uix-sticky",function(t){new t.mt.uix.Sticky(o,{canDisappear:!0,mainAreaWidth:i.mainAreaWidth,bottomEdge:i.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:i.minScrollTop,vBottomOffset:i.bottomOffset})})}}(m.voteConfig),function(o){var e,a=n.one("#fixbar-item-help");if(a){if(o=o||{},o.hide)return void a.hide();t.mix(o,{mainAreaWidth:980,bottomOffset:20,minScrollTop:0,bottomEdge:".site-info-w"}),t.use("uix-sticky",function(t){new t.mt.uix.Sticky(n,{canDisappear:!0,mainAreaWidth:o.mainAreaWidth,bottomEdge:o.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:o.minScrollTop,vBottomOffset:o.bottomOffset})}),t.one(document.body).delegate("click",function(t){t.preventDefault(),e?e.open():e=i.RightbottomSticky.help()},".J-lift-help")}}(m.helpConfig),function(i){var o,e=n.one("#fixbar-item-feedback");if(e){if(i=i||{},i.hide)return void e.hide();t.mix(i,{mainAreaWidth:980,bottomOffset:20,minScrollTop:0,ga:"",bottomEdge:".site-info-w"}),i.url&&(i.ga&&(i.ga='gaevent="'+i.ga+'"'),o='<a target="_blank" class="new-index-triffle lift-nav lift-nav--feedback" hidefocus="true"'+i.ga+' href="'+i.url+'"><i></i><span>意见反馈</span></a>',e.setHTML(o),t.use("uix-sticky",function(t){new t.mt.uix.Sticky(e,{canDisappear:!0,mainAreaWidth:i.mainAreaWidth,bottomEdge:i.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:i.minScrollTop,vBottomOffset:i.bottomOffset})}))}}(m.feedbackConfig)}},help:function(){var i,a;return i=new e({id:"help-center-dialog",title:"帮助中心",width:"681px",content:'<div class="loading-jump--large" style="height:365px;"></div>'}),i.open(),a=t.one("#help-center-dialog"),n("/help/center",{method:"POST",on:{success:function(t,e){var n=o.getEvalRes(e);i.set("content",n.content),a.one(".body").setStyle("height","365px"),i.set("centered",!0)}}}),i}},t.mt.ComponentHub.attach("rightbottom-sticky",function(t){i.RightbottomSticky.init(t)})},"1.0.0",{requires:["mt-base","mt-dialog"]});
