;M.add("review-list",function(t){function e(t){return"."+t}var i=t.io,a=t.mt.util,n=function(){this._attrs={tab:"all",withContent:!0,sortType:"default",label:null}};n.prototype={constructor:n,set:function(t,e){this.get(t)!==e&&(this._set(t,e),this._updateRestAttrs(t,e),this.fire("attrchange"))},get:function(t){return this._attrs[t]},_set:function(t,e){this._attrs[t]=e},_updateRestAttrs:function(t,e){switch(t){case"label":return void this._afterLabelChange(e);case"withContent":return void this._afterWithContentChange(e);case"tab":this._afterTabChange(e)}},_afterLabelChange:function(t){t&&(this._set("tab",null),this._set("withContent",!0))},_afterWithContentChange:function(t){var e=this.get("tab");t||("withpic"!==e&&null!==e||this._set("tab","all"),this._set("label",null))},_afterTabChange:function(t){null!==t&&("withpic"===t&&this._set("withContent",!0),this._set("label",null))}},t.augment(n,t.EventTarget);var l=function(e){var i={rateFilter:null,placeholder:null,action:""};this.config=t.merge(i,e),this.ndLabelsWrapper=null};l.CLASS_LABELS_WRAPPER="J-labels-wrapper",l.prototype={constructor:l,init:function(){var t=this;i(this.config.action,{method:"GET",on:{success:function(e,i){var n,l,r,s,o=a.getEvalRes(i);(n=o.data)&&(l=n.length)&&(r=o.trackData,r&&(s=r.pm),window._mbq("trackModuleview",r),t._render(n,l,s),t._bindEvents())}}})},_render:function(e,i,a){var n,r,s,o,c,d=a?'data-mod="'+a+'"':"",h='<div class="rate-labels-wrapper '+l.CLASS_LABELS_WRAPPER+'" '+d+'><p class="title">大家都在说：</p><div class="labels">',g=1,u=1,f=this.config.placeholder;for(n=0;n<i;n++)s="rate-label",r=e[n],r.isPositive?(s+=" rate-label--positive",c="content/detail/reviews/cloud/good"+g,g++):(c="content/detail/reviews/cloud/bad"+u,u++),h+='<a href="#" class="'+s+'" data-label="'+r.label+'" hidefocus="true" gaevent="'+c+'">'+r.label+"("+r.count+")</a>";h+="</div></div>",o=this.ndLabelsWrapper=t.Node.create(h),f&&f.insert(o,"after")},_bindEvents:function(){var e=this.ndLabelsWrapper,i=this.config.rateFilter;i.on("attrchange",t.bind(this._updateView,this)),e.delegate("click",function(t){t.preventDefault();var e=t.target,a=e.getData("label");a!==i.get("label")&&i.set("label",a)},"a")},_updateView:function(){var t=this.ndLabelsWrapper,e=this.config.rateFilter,i=e.get("label");if(t){var a,n="rate-label--positive--active",l=t.one(".rate-label--active, ."+n);l&&(l.removeClass("rate-label--active"),l.removeClass(n)),i&&(a=t.one('[data-label="'+i+'"]'),a.hasClass("rate-label--positive")?a.addClass(n):a.addClass("rate-label--active"))}}};var r=function(i){var a,s={pageLimit:10,hasLabelCloud:!1,labelCloudAction:null,labelPlaceholder:"#J-overview",isDeal:!0,dealId:0,poiId:"all",cityId:0,showPoiTitle:"0",ndWrapper:t.one(e(r.CLASS_RATE_LIST_WRAPPER)),ndFilter:t.one(e(r.CLASS_FILTER_WRAPPER)),ndWithContent:t.one(e(r.CLASS_WITH_CONTENT_CHECKBOX)),ndSortSelect:t.one(e(r.CLASS_SORT_TYPE_SELECT)),ndPageNav:t.one(e(r.CLASS_PAGE_NAV))};if(this.config=i=t.merge(s,i),i.isDeal&&"all"===i.dealId||!i.isDeal&&"all"===i.poiId)return null;i.rateFilter=new n,a=t.one(this.config.labelPlaceholder),i.hasLabelCloud&&void 0!==a&&(i.labelCloud=new l({rateFilter:i.rateFilter,placeholder:a,action:i.labelCloudAction})),this.init()};r.CLASS_RATE_LIST_WRAPPER="J-rate-wrapper",r.CLASS_RATE_LIST="J-rate-list",r.CLASS_RATE_LIST_LOADING="J-list-loading",r.CLASS_FILTER_WRAPPER="J-rate-filter",r.CLASS_WITH_CONTENT_CHECKBOX="J-rate-withcontent",r.CLASS_PAGE_NAV="J-rate-paginator",r.CLASS_SORT_TYPE_SELECT="J-filter-ordertype",r.CLASS_TAB_LINK="J-filter-link",r.TPL_LOADING='<div class="loading-surround--large ratelist-content__loading J-list-loading"></div>',r._cachedRatelist={},r.prototype={constructor:r,init:function(){var i,a=this.config,n=a.labelCloud,l=this.config.ndWrapper;this._ndLoading=t.Node.create(r.TPL_LOADING),this._ndRatelist=l.one(e(r.CLASS_RATE_LIST)),l.insert(this._ndLoading,this._ndRatelist),this._ndLoading.hide(),n&&n.init(),this._bindFilterEvents(),r.bindEvents(this.config.ndWrapper),this._ndRatelist.getData("fetchfirstpage")?this._refreshRatelist():(i=parseInt(this.config.ndPageNav.getData("total"),10),this._renderPageNav(i,0),r.renderRatePicList(this.config.ndWrapper))},_refreshRatelist:function(e){var i,n,l=this.config,r=this,s=l.rateFilter,o=s.get("tab"),c=s.get("label"),d={dealId:l.dealId,cityId:l.cityId,id:l.dealId,poiId:l.poiId,filter:"all",withContent:0,sortType:s.get("sortType"),label:"",isPoi:""},h={limit:l.pageLimit,showpoititle:l.showPoiTitle,offset:e||0};"withpic"===o?h.withpic=1:o&&(d.filter=o),c?(n="/deal/{isPoi}feedbacklistbylabel/{id}/{label}/{sortType}",d.label=encodeURI(c),"all"!==l.poiId&&(d.isPoi="poi",d.id=l.poiId)):n="/deal/feedbacklist/{dealId}/{poiId}/{filter}/{withContent}/{sortType}/{cityId}",i=t.Lang.sub(n,d),i=i+"?"+a.toPostData(h),this._fetchReviewListData(i,function(e){var i=e.data;e.status&&(r._renderRateList(i.ratelistHtml),r._renderPageNav(i.total,h.offset),t.Global.fire("PageHeight:change"))})},_fetchReviewListData:function(t,e){var n,l,s=r._cachedRatelist[t];if(s)return void e(s);this.config.ndWrapper,n=this._ndLoading,l=this._ndRatelist,n.show(),l.hide(),i(t,{method:"GET",on:{success:function(i,s){n.hide(),l.show();var o=a.getEvalRes(s);r._cachedRatelist[t]=o,e(o)}}})},_renderPageNav:function(e,i){new t.mt.www.PageNav(this.config.ndPageNav).render({currentPage:Math.ceil((parseInt(i,10)+1)/this.config.pageLimit),maxPage:Math.ceil(e/this.config.pageLimit),gaBase:"content/detail/reviews/prepage"})},_renderRateList:function(t){var e=this._ndRatelist;e.setHTML(t),r.renderRatePicList(e)},_bindFilterEvents:function(){var t=this.config.ndWrapper,i=this,n=this.config.rateFilter,s=this.config.ndFilter,o=this.config.ndSortSelect,c=this.config.ndWithContent;n.on("attrchange",function(){i._updateFilterView(),i._refreshRatelist()}),c.on("change",function(t){var e,i=t.target;e=i.get("checked"),n.set("withContent",e)}),s.delegate("click",function(t){t.preventDefault();var e=this.getData("tab");e!==n.get("tab")&&n.set("tab",e)},e(r.CLASS_TAB_LINK)),o.on("change",function(){var t=o.get("value");n.set("sortType",t)}),this.config.ndPageNav.delegate("click",function(){var n,r=this,o=1,c=t.one(e(l.CLASS_LABELS_WRAPPER)),d="";o=a.data(r,"index"),c?window.scrollTo(0,c.getY()-46):window.scrollTo(0,s.getY()-46),d=this.getAttribute("data-index"),d&&d.length<2&&(d="0"+d),window._gaq.push(["_trackEvent","InnerLink","Click","content/detail/review/page"+d]),n=(o-1)*i.config.pageLimit,i._refreshRatelist(n)},"a")},_updateFilterView:function(){this._updateFilterWithContent(),this._updateFilterTabs()},_updateFilterWithContent:function(){var t=this.config.ndWithContent,e=this.config.rateFilter,i=e.get("withContent");t.set("checked",i)},_updateFilterTabs:function(){var t=this.config,e=t.rateFilter,i=t.ndFilter,a=e.get("tab"),n=i.one(".rate-filter__link--active"),l=i.one('[data-tab="'+a+'"]');n&&n.removeClass("rate-filter__link--active"),l&&l.addClass("rate-filter__link--active")}};var s={bindEvents:function(t){t.delegate("click",function(){s.agreeEvaluate(this,this.getData("feedbackId"))},".J-useful"),t.delegate("click",function(t){t.halt();var e=this.ancestor(".J-ratelist-item"),i=e.getData("rateid"),a=e.one(".J-normal-view"),n=e.one(".J-long-view");if(n.getData("rendered"))return a.toggleView(),n.toggleView(),void window.scrollTo(0,e.getY()-46);s.getRateLongDetail(i,function(t){n.setHTML(t.comment),n.setData("rendered",!0),a.toggleView(),n.toggleView(),n.append('<p><a href="#" class="J-show-moreorless">收起</a></p>')})},".J-show-moreorless")},agreeEvaluate:function(e,n){var l,r,s=e.siblings(".J-agree-tips"),o={dealfeedbackid:n};l=t.Lang.sub("/deal/vote/{dealfeedbackid}",o),r=parseInt(e.getData("agreed"),10),i(l,{method:"POST",on:{success:function(t,i){var n=a.getEvalRes(i);0===n.status&&(r+=1,e.set("title","有"+r+"人认为这条评价有用"),e.set("data-feedbackId",r),e.setHTML('有用<span class="number">('+r+")</span>")),s.set("text",n.msg)}}})},getRateLongDetail:function(t,e){i("/rates/longdetail/"+t,{method:"GET",on:{success:function(t,i){var n=a.getEvalRes(i);e(n)}}})},buildSingleRatePicItem:function(t){var e,i,a,n;if(!t)return"";if(!(n=t.length))return"";for(a='<div class="pic-list J-piclist-wrapper"><div class="J-pic-thumbnails pic-thumbnails"><ul class="pic-thumbnail-list">',e=0;e<n;e++)i=t[e],a+='<li data-src="'+i.url+'"><a class="pic-thumbnail" href="#" hidefocus="true">    <img src="'+i.url.replace("/w.h/","/126.126/")+'"/></a></li>';return a+='</ul></div><div class="J-pic-preview pic-preview"></div></div>'},renderRatePicList:function(e){if(e){var i=e.all(".J-piclist-wrapper");i.isEmpty()||t.use("w-carousel",function(t){i.each(function(e){new t.mt.widget.Carousel({contentBox:e,ndCarousel:".J-pic-preview",ndIndicatorWrap:".J-pic-thumbnails",fillLastPage:!0,getCarouselSrc:function(t){return t.getData("src").replace("/w.h/","/668.500/")}}).render()})})}}};t.mix(r,s),t.namespace("mt.www.ReviewList"),t.mt.www.ReviewList=r,t.mt.ComponentHub.attach("review-list",function(i){var a=i.component.params;t.mt.ViewportTracker.onceenter(t.one(e(a.ndWrapper||r.CLASS_RATE_LIST_WRAPPER)),function(){new r(a)})})},"1.0.0",{requires:["www-base","www-pagenav","mt-viewporttracker"]});
;M.add("rightbottom-sticky",function(t){var i=t.mt.www,o=t.mt.util,e=t.mt.Dialog,n=t.io;i.RightbottomSticky={init:function(e){var n,a;if((n=e.component.node)&&(a=n.one("#fixbar-container"))){var m=o.decodeJSON(a.getData("config"))||{};t.mix(m,{topConfig:{},voteConfig:{},helpConfig:{},feedbackConfig:{},containerConfig:{}}),function(i,o){i&&(o=o||{},t.mix(o,{mainAreaWidth:980,bottomEdge:".site-info-w",bottomOffset:20}),t.use("uix-sticky",function(t){new t.mt.uix.Sticky(i,{canDisappear:!0,mainAreaWidth:o.mainAreaWidth,bottomEdge:o.bottomEdge,hAlign:"right",vAlign:"bottom",vBottomOffset:o.bottomOffset})}))}(a,m.containerConfig),function(i){var o=n.one("#fixbar-item-top");o&&(i=i||{},t.mix(i,{maxAreaWidth:980,bottomEdge:".site-info-w",content:"",minScrollTop:140,bottomOffset:20}),t.use("uix-smoothscroll","uix-sticky",function(t){t.mt.uix.Smoothscroll(o,{trigger:".J-go-top"}),new t.mt.uix.Sticky(o,{canDisappear:!0,mainAreaWidth:i.mainAreaWidth,bottomEdge:i.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:i.minScrollTop,vBottomOffset:i.bottomOffset})}))}(m.topConfig),function(i){var o=n.one("#fixbar-item-vote");if(o){if(i=i||{},i.hide)return void o.hide();t.mix(i,{maxAreaWidth:980,bottomOffset:20,minScrollTop:0,bottomEdge:".site-info-w",ga:"",url:"/survey/82"}),t.use("uix-sticky",function(t){new t.mt.uix.Sticky(o,{canDisappear:!0,mainAreaWidth:i.mainAreaWidth,bottomEdge:i.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:i.minScrollTop,vBottomOffset:i.bottomOffset})})}}(m.voteConfig),function(o){var e,a=n.one("#fixbar-item-help");if(a){if(o=o||{},o.hide)return void a.hide();t.mix(o,{mainAreaWidth:980,bottomOffset:20,minScrollTop:0,bottomEdge:".site-info-w"}),t.use("uix-sticky",function(t){new t.mt.uix.Sticky(n,{canDisappear:!0,mainAreaWidth:o.mainAreaWidth,bottomEdge:o.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:o.minScrollTop,vBottomOffset:o.bottomOffset})}),t.one(document.body).delegate("click",function(t){t.preventDefault(),e?e.open():e=i.RightbottomSticky.help()},".J-lift-help")}}(m.helpConfig),function(i){var o,e=n.one("#fixbar-item-feedback");if(e){if(i=i||{},i.hide)return void e.hide();t.mix(i,{mainAreaWidth:980,bottomOffset:20,minScrollTop:0,ga:"",bottomEdge:".site-info-w"}),i.url&&(i.ga&&(i.ga='gaevent="'+i.ga+'"'),o='<a target="_blank" class="new-index-triffle lift-nav lift-nav--feedback" hidefocus="true"'+i.ga+' href="'+i.url+'"><i></i><span>意见反馈</span></a>',e.setHTML(o),t.use("uix-sticky",function(t){new t.mt.uix.Sticky(e,{canDisappear:!0,mainAreaWidth:i.mainAreaWidth,bottomEdge:i.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:i.minScrollTop,vBottomOffset:i.bottomOffset})}))}}(m.feedbackConfig)}},help:function(){var i,a;return i=new e({id:"help-center-dialog",title:"帮助中心",width:"681px",content:'<div class="loading-jump--large" style="height:365px;"></div>'}),i.open(),a=t.one("#help-center-dialog"),n("/help/center",{method:"POST",on:{success:function(t,e){var n=o.getEvalRes(e);i.set("content",n.content),a.one(".body").setStyle("height","365px"),i.set("centered",!0)}}}),i}},t.mt.ComponentHub.attach("rightbottom-sticky",function(t){i.RightbottomSticky.init(t)})},"1.0.0",{requires:["mt-base","mt-dialog"]});
;M.add("downtip",function(n){n.mt.www.DownTip={handle:function(){var t=n.one(".tip-contain");n.one(".close-it").on("click",function(){t.hasClass("tip-contain")&&t.removeClass("tip-contain").addClass("closetip")})}},n.mt.ComponentHub.attach("downtip",function(){n.mt.www.DownTip.handle()})},"1.0.0",{requires:["www-base"]});
;M.add("soso-map",function(e){var o=e.io,n=e.Lang.isArray,t=e.Lang.trim,a=e.mt.util,i=e.mt.www,r=e.mt.Dialog,s=e.mt.lang;e.mt.www.Map={showBizMap:function(o,n){window.qq&&window.qq.maps?i.Map.printBizMap(o,n):M.load(function(){e.Get.js("//map.qq.com/api/js?v=2.exp&callback=Y.mt.www.Map.callback",function(e){e||i.Map.printBizMap(o,n)})})},printBizMap:function(c,p){function l(){e.Array.each(L.get("markers"),function(e,o){e.setAnimation(q.MarkerAnimation.DROP),L.addListener(e,"click",function(){m(),j.openInfoWindow(o)})})}function u(){var o=c.shops;c.shops={},e.Object.each(o,function(e,o){e.name&&n(e.position)&&2===e.position.length&&(c.shops[o]=e)})}function d(){var o={container:y,markers:[],options:{scrollwheel:!0}};e.mix(o,c,!1,["center","zoom"]),e.Object.each(c.shops,function(e){o.markers.push({position:e.position,title:e.name})}),1!==o.markers.length||o.zoom||(o.zoom=16,o.center=o.markers[0].position),L=new e.mt.Map(o),l(),L.render(),L.get("map")&&B.on("click",function(){m()})}function h(){if(!c.shops)return void A.each(function(e){e.all(".view-map, .search-path, .correct-poi").hide()});A.each(function(e){e.delegate("click",function(e){e.preventDefault();var o=a.data(this,"id"),n=a.data(this,"poiid"),t=c.shops[o];t&&m(t,o,n)},".view-map"),e.delegate("click",function(e){e.halt();var o=a.data(this,"id"),n=c.shops[o];n&&f(n)},".search-path"),e.delegate("click",function(e){e.halt();var o=a.data(this,"id"),n=a.data(this,"poiid"),t=c.shops[o];t&&w(t,n)},".correct-poi")})}function m(o,n,t){var a,i,p,l="",u=[],d=b(o,n),h=o?o.name:c.name;o&&(l='<a href="javascript:void(0)" class="correct-poi">信息纠错</a>'),h=d.markers.length>1?s.truncateStr(h,16,"..."):h,z=new r({id:H,width:"770px",content:e.Lang.sub(D.getHTML(),{title:h,errorToCorrect:l})}),z.open(),a=e.one("#"+H),i=a.one(".map-container"),z.on("close",function(){i.hide()}),a.delegate("click",function(e){e.halt();var o=c.shops[n];o&&t&&(z.close(),w(o,t))},".correct-poi"),a.delegate("click",function(){window._gaq.push(["_trackEvent","InnerLink","Click","map/view/close"])},".close"),j&&j.destroy(),j=M(a,d),j.render(),j.get("map")&&(1===d.markers.length?j.openInfoWindow(0):(p=a.one(".select-shop"),e.Object.each(c.shops,function(e,o){u.push('<option value="'+o+'">'+e.name+"</option>")}),p.append(u.join("")),p.show(),p.on("change",function(){var o=this.get("value"),n=e.Array.indexOf(C,o);j.openInfoWindow(n)})))}function f(o){var n=null;O=new r({id:S,width:"420px",title:"查询线路",content:e.Lang.sub(E.getHTML(),{shopName:o.name,shopLatLng:o.position.concat().reverse().join()})}),O.open(),n=e.one("#"+S),v(n)}function w(o,n){var t=null;I&&(x=new r({id:W,width:"520px",title:"信息报错",content:e.Lang.sub(I.getHTML(),{shopName:o.name,shopAddress:o.address,shopPhone:o.phone,poiid:n})}),x.open(),t=e.one("#"+W),g(t))}function v(e){var o=e.one("form"),n=e.one(".error"),t=a.field(o,"from");o.on("submit",function(e){return e.halt(),""===t.get("value")?(n.setHTML("请填写您的出发地").setStyle("display","block"),t.focus(),!1):(n.hide(),o.submit(),!0)})}function g(n){function r(){return!(t(l.get("value"))&&!l.hasClass("placeholder")||u.get("checked")||h.get("checked"))}var s=n.one("form"),c=s.one('input[type="submit"]'),p=n.one("div.correct-group"),l=n.one("#correct-poi-info"),u=n.one("#number-error"),d=n.one(".field-group--error"),h=n.one("#connect-error");e.one("body").on("keydown",function(o){o.keyCode===e.mt.macro.key.ESC&&x.close()}),s.delegate("click",function(e){var o=e.target;"true"===a.data(o,"phoneerror")?(p.show(),p.one("input").focus()):p.hide()},'input[name="type"]'),l.plug(e.mt.plugin.Placeholder),s.on("submit",function(e){if(e.halt(),r())return void d.show();d.hide(),i.disableButton(c,!0),o(s.get("action"),{method:"POST",form:{id:s},on:{success:function(e,o){k(!!a.getEvalRes(o).status)},failure:function(){}}})})}function k(e){var o;o=e?{type:"success",title:"提交成功！",tip:"感谢您的报错信息."}:{type:"failure",title:"提交失败",tip:"网络有问题，请稍候重试"},x.showResult(o),x.set("autoHide",2)}function b(o,n){var t=c.shops,a={center:[],defaultZoom:16,markers:[],infoWindows:[]};return o&&(t={},t[n]=o),C=[],e.Object.each(t,function(o,n){var t=[],i=e.Lang.sub(T,{destination:o.position.concat().reverse().join()});t.push('<div class="info-window"><h5>'+o.name+"</h5>"),o.address&&t.push('<p class="detail">'+o.address+"</p>"),o.phone&&t.push('<p class="detail">'+o.phone+"</p>"),t.push('<p><a href="'+i+'" target="_blank" gaevent="map/view/queryroute">公交/驾车路线查询&raquo;</a></p></div>'),a.markers.push({position:o.position,title:o.name}),a.infoWindows.push(t.join("")),C.push(n)}),a}function M(o,n){var t={container:o.one(".map-container"),options:{mapTypeControl:!0,zoomControlOptions:{style:q.ZoomControlStyle.LARGE},panControl:!0,scaleControl:!0}};return e.mix(n,t),new e.mt.Map(n)}var y,q=window.qq&&window.qq.maps;if(c&&q&&(!p||(y=e.one("#map-canvas")))){var L,j,C,z,O,x,A=e.all(".address-list"),B=y&&y.next(".J-view-full"),T="//map.qq.com/?type=nav&tocoord={destination}&c={destination}&l=13",H="deal-view-map-dialog",S="deal-search-path-dialog",W="correct-poi-dialog",D=e.one("#view-map-markup"),E=e.one("#search-path-markup"),I=e.one("#correct-poi-markup");e.use("mt-map",function(){p&&(u(),d()),A&&h()}),e.Global.on("dealMapMarkers:change",function(o,n){var t=[];L.deleteMarkers(),e.Object.each(o.shops,function(e){t.push({position:e.position,title:e.name})}),L.set("markers",t),L.drawMarkers(),L.set("bounds",L.get("markers")),L.fitBounds(),l(),n&&n()})}},callback:function(){}},e.mt.ComponentHub.attach("soso-map",{ready:function(o){var n=o.component,t=n.params,a=t.callback;if(a&&"function"==typeof a)return void a();e.mt.www.Map.showBizMap(t.mapData,t.flag)}})},"1.0.0",{requires:["www-base","mt-dialog"]});
